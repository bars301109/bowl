
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã - Akylman Quiz Bowl">
  <title data-i18n="team.title">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="../css/style.css"/>
  <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
</head>
<body class="admin-panel">
<div class="container">
  <div class="lang-switch text-end" role="group" aria-label="–í—ã–±–æ—Ä —è–∑—ã–∫–∞">
    <button data-lang="ru" aria-label="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫" aria-pressed="true">–†–£</button> 
    <button data-lang="ky" aria-label="–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π —è–∑—ã–∫" aria-pressed="false">–ö–´</button>
  </div>
  <a href="/" aria-label="–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"><img src="../images/logos.jpeg" class="logo-center img-fluid" alt="Akylman Quiz Bowl" width="120" height="48"/></a>
  <nav class="topbar d-flex justify-content-end gap-2 flex-wrap" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <a class="nav-btn" href="/" data-i18n="nav.home" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É">–ì–ª–∞–≤–Ω–∞—è</a>
    <button class="link-pill" id="logout" data-i18n="nav.logout" aria-label="–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞" type="button">–í—ã—Ö–æ–¥</button>
  </nav>
  <main class="team-page-main" role="main">
    <h1 data-i18n="team.title" class="sr-only">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</h1>
    <h2 data-i18n="team.title" class="visually-hidden">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</h2>
    <div class="team-layout">
      <nav class="team-tabs" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º">
        <h2 id="teamNameHeader" class="team-name-header">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <button id="tabHome" class="tab-btn active" role="tab" aria-selected="true" aria-controls="tabContent" data-section="main" data-i18n="team.tab.home" tabindex="0">–ì–ª–∞–≤–Ω–∞—è</button> 
        <button id="tabTests" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="tests" data-i18n="team.tab.tests" tabindex="-1">–¢–µ—Å—Ç—ã</button> 
        <button id="tabResults" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="results" data-i18n="team.tab.results" tabindex="-1">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button> 
        <button id="tabSettings" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="settings" data-i18n="team.tab.settings" tabindex="-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button> 
        <button id="tabPractice" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="practice" data-i18n="team.tab.practice" tabindex="-1">–ü—Ä–∞–∫—Ç–∏–∫–∞</button> 
        <button id="tabRules" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="rules" data-i18n="team.tab.rules" tabindex="-1">–ü—Ä–∞–≤–∏–ª–∞</button>
      </nav>
      <div id="tabContent" class="team-main" role="tabpanel" aria-labelledby="tabHome" aria-live="polite"></div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="../js/i18n.js"></script>
<script>AkylI18n.initSwitcher();</script>
<script>
const token = localStorage.getItem('akylman_token');
if (!token) location.href = '/login';

let teamData = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
function t(key) {
  if (typeof AkylI18n !== 'undefined' && AkylI18n.t) {
    return AkylI18n.t(key);
  }
  return key;
}

function updateTeamNameHeader() {
  const teamNameHeader = document.getElementById('teamNameHeader');
  if (teamNameHeader && teamData) {
    teamNameHeader.textContent = teamData.team_name || '–ö–æ–º–∞–Ω–¥–∞';
  }
}

async function load() {
  const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
  const j = await res.json();
  if (!j.ok) {
    localStorage.removeItem('akylman_token');
    location.href = '/login';
    return;
  }
  teamData = j.team;
  updateTeamNameHeader();
}

load();

document.getElementById('logout').onclick = () => {
  localStorage.removeItem('akylman_token');
  localStorage.removeItem('team');
  location.href = '/';
};

function setActiveTab(btn) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('active');
    b.setAttribute('aria-selected', 'false');
    b.setAttribute('tabindex', '-1');
  });
  btn.classList.add('active');
  btn.setAttribute('aria-selected', 'true');
  btn.setAttribute('tabindex', '0');
  document.getElementById('tabContent').setAttribute('aria-labelledby', btn.id);
}

async function renderHomeSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
  if (!teamData) {
    try {
      const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
      const j = await res.json();
      if (j.ok) {
        teamData = j.team;
        updateTeamNameHeader();
      }
    } catch (err) {
      console.error(err);
      out.setAttribute('aria-busy', 'false');
      out.innerHTML = '<div class="error-message" role="alert"><p style="color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p></div>';
      return;
    }
  }
  
  out.setAttribute('aria-busy', 'false');
  
  if (teamData) {
    // –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã
    let membersHtml = '';
    if (teamData.members && teamData.members.length > 0) {
      membersHtml = teamData.members.map((m, idx) => `<li><span class="member-name">${m.name || '–£—á–∞—Å—Ç–Ω–∏–∫'}</span>${m.class ? ` <span class="member-class">‚Äî ${m.class}</span>` : ''}</li>`).join('');
    } else {
      membersHtml = '<li class="empty-state">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</li>';
    }
    
    out.innerHTML = `
      <section aria-labelledby="welcome-heading">
        <h3 id="welcome-heading" data-i18n="team.welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã!</h3>
        <div class="team-info" role="region" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–µ">
          <dl class="info-list">
            <div class="info-item editable" data-field="team_name">
              <dt data-i18n="team.team_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.team_name || '')}</span>
                <button type="button" class="inline-edit-btn" data-field="team_name">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            <div class="info-item editable" data-field="captain_name">
              <dt data-i18n="team.captain">–ö–∞–ø–∏—Ç–∞–Ω:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.captain_name || '')}</span>
                <button type="button" class="inline-edit-btn" data-field="captain_name">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ${teamData.captain_phone ? `
            <div class="info-item editable" data-field="captain_phone">
              <dt data-i18n="team.phone">–¢–µ–ª–µ—Ñ–æ–Ω:</dt>
              <dd>
                <span class="info-value"><a href="tel:${escapeHtml(teamData.captain_phone)}" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–∞–ø–∏—Ç–∞–Ω—É">${escapeHtml(teamData.captain_phone)}</a></span>
                <button type="button" class="inline-edit-btn" data-field="captain_phone">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ` : `
            <div class="info-item editable" data-field="captain_phone">
              <dt data-i18n="team.phone">–¢–µ–ª–µ—Ñ–æ–Ω:</dt>
              <dd>
                <span class="info-value small-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                <button type="button" class="inline-edit-btn" data-field="captain_phone">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            `}
            ${teamData.school ? `
            <div class="info-item editable" data-field="school">
              <dt data-i18n="team.school">–®–∫–æ–ª–∞:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.school)}</span>
                <button type="button" class="inline-edit-btn" data-field="school">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ` : `
            <div class="info-item editable" data-field="school">
              <dt data-i18n="team.school">–®–∫–æ–ª–∞:</dt>
              <dd>
                <span class="info-value small-muted">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                <button type="button" class="inline-edit-btn" data-field="school">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            `}
            ${teamData.city ? `
            <div class="info-item editable" data-field="city">
              <dt data-i18n="team.city">–ì–æ—Ä–æ–¥:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.city)}</span>
                <button type="button" class="inline-edit-btn" data-field="city">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ` : `
            <div class="info-item editable" data-field="city">
              <dt data-i18n="team.city">–ì–æ—Ä–æ–¥:</dt>
              <dd>
                <span class="info-value small-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                <button type="button" class="inline-edit-btn" data-field="city">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            `}
          </dl>

          <section aria-labelledby="members-heading">
            <h4 id="members-heading" data-i18n="team.members">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã:</h4>
            <ul class="members-list" role="list">
              ${membersHtml}
            </ul>
          </section>

          <section class="account-section" aria-labelledby="account-heading">
            <h4 id="account-heading">–ê–∫–∫–∞—É–Ω—Ç</h4>
            <dl class="info-list">
              ${teamData.captain_email ? `
              <div class="info-item">
                <dt data-i18n="team.email">Email –∫–∞–ø–∏—Ç–∞–Ω–∞:</dt>
                <dd><a href="mailto:${escapeHtml(teamData.captain_email)}" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å email –∫–∞–ø–∏—Ç–∞–Ω—É">${escapeHtml(teamData.captain_email)}</a></dd>
              </div>
              ` : ''}
              <div class="info-item">
                <dt>–ü–∞—Ä–æ–ª—å:</dt>
                <dd>
                  <span class="info-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                  <button type="button" class="inline-edit-btn" data-field="password">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </dd>
              </div>
            </dl>
          </section>
        </div>
      </section>
    `;

    // –ù–∞–≤–µ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å"
    out.querySelectorAll('.inline-edit-btn').forEach(btn => {
      const field = btn.getAttribute('data-field');
      if (field === 'password') {
        btn.addEventListener('click', handlePasswordChange);
      } else {
        btn.addEventListener('click', () => handleInlineEdit(field));
      }
    });
  } else {
    out.innerHTML = '<div class="empty-state" role="status"><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
  }
  
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderRulesSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.innerHTML = `
    <section aria-labelledby="rules-heading">
      <h3 id="rules-heading" data-i18n="team.tab.rules">–ü—Ä–∞–≤–∏–ª–∞</h3>
      <p data-i18n="team.rules.hidden_note">–ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –∑–¥–µ—Å—å.</p>
      <div class="iframe-wrapper">
        <iframe 
          src="../pages/rules.pdf" 
          title="–ü—Ä–∞–≤–∏–ª–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è"
          aria-label="–î–æ–∫—É–º–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è"
          style="width:100%;height:480px;border:1px solid #eef4fb;border-radius:10px">
        </iframe>
      </div>
    </section>
  `;
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

function renderPracticeSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.innerHTML = `
    <section aria-labelledby="practice-heading">
      <h3 id="practice-heading" data-i18n="team.tab.practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</h3>
      <div class="practice-content" role="region" aria-label="–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏">
        <div class="practice-section">
          <h4>–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω —Ç–∞–∞–Ω—É—É ‚Äî “Ø–ª–≥“Ø —Å—É—Ä–æ–æ–ª–æ—Ä</h4>
          <ol class="practice-list">
            <li>–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –±–æ—Ä–±–æ—Ä—É –∫–∞–π—Å—ã? ‚Äî <strong>–ë–∏—à–∫–µ–∫</strong></li>
            <li>–´—Å—ã–∫-–ö”©–ª –∫–∞–π—Å—ã –¥—É–±–∞–Ω–¥–∞ –∂–∞–π–≥–∞—à–∫–∞–Ω? ‚Äî <strong>–´—Å—ã–∫-–ö”©–ª –æ–±–ª—É—Å—É</strong></li>
            <li>–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –º–∞–º–ª–µ–∫–µ—Ç—Ç–∏–∫ —Ç–∏–ª–∏? ‚Äî <strong>–ö—ã—Ä–≥—ã–∑ —Ç–∏–ª–∏</strong></li>
          </ol>
        </div>
        <div class="practice-section">
          <h4>–ê–¥–∞–±–∏—è—Ç ‚Äî “Ø–ª–≥“Ø —Å—É—Ä–æ–æ–ª–æ—Ä</h4>
          <ol class="practice-list">
            <li>¬´–ú–∞–Ω–∞—Å¬ª —ç–ø–æ—Å—É–Ω—É–Ω –±–∞—à–∫—ã –∫–∞–∞—Ä–º–∞–Ω—ã –∫–∏–º? ‚Äî <strong>–ú–∞–Ω–∞—Å</strong></li>
            <li>–ê. –ü—É—à–∫–∏–Ω–¥–∏–Ω –∫–∞–π—Å—ã —á—ã–≥–∞—Ä–º–∞—Å—ã–Ω–¥–∞ –¢–∞—Ç—å—è–Ω–∞ –±–∞—Ä? ‚Äî <strong>–ï–≤–≥–µ–Ω–∏–π –û–Ω–µ–≥–∏–Ω</strong></li>
            <li>¬´–´—Å—ã–∫-–ö”©–ª–¥“Ø–Ω –∫—É–ª–∞–≥—ã¬ª —á—ã–≥–∞—Ä–º–∞ –∫–∞–π—Å—ã –∂–∞–Ω—Ä–¥–∞? ‚Äî <strong>–ü–æ–≤–µ—Å—Ç—å/—ç—Å—Å–µ (–∫–æ–Ω—Ç–µ–∫—Å—Ç—Ç–∏–∫ –∫–∞–±—ã–ª)</strong></li>
          </ol>
        </div>
        <p class="small-muted practice-note">–ë—É–ª “Ø–ª–≥“Ø–ª”©—Ä —Ñ–æ—Ä–º–∞—Ç –º–µ–Ω–µ–Ω —Ç–∞–∞–Ω—ã—à—Ç—ã—Ä—É—É “Ø—á“Ø–Ω –≥–∞–Ω–∞.</p>
      </div>
    </section>
  `;
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

async function renderTestsSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤...</span></div><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  try {
    const res = await fetch('/api/tests');
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const tests = await res.json();
    out.setAttribute('aria-busy', 'false');
    
    if (!tests.length) {
      out.innerHTML = `
        <div class="empty-state" role="status" aria-live="polite">
          <div class="empty-icon">üìù</div>
          <p data-i18n="team.no_tests" class="empty-message">–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤</p>
          <p class="empty-hint">–¢–µ—Å—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å, –∫–æ–≥–¥–∞ –æ–Ω–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã.</p>
        </div>
      `;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
    function renderWindow(t) {
      if (t.window_start && t.window_end) {
        return `<span class="test-window" aria-label="–ü–µ—Ä–∏–æ–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∞">(${t.window_start} ‚Üí ${t.window_end})</span>`;
      }
      return '';
    }
    
    out.innerHTML = `
      <section aria-labelledby="tests-heading">
        <h3 id="tests-heading" class="sr-only" data-i18n="team.tab.tests">–¢–µ—Å—Ç—ã</h3>
        <ul class="test-list" role="list" aria-label="–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤">
          ${tests.map((t, idx) => `
            <li role="listitem" class="test-card">
              <div class="test-card-header">
                <h4 class="test-title">${escapeHtml(t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h4>
                ${renderWindow(t)}
              </div>
              ${t.description ? `<p class="test-description">${escapeHtml(t.description)}</p>` : ''}
              <button 
                data-id="${t.id}" 
                class="take primary" 
                data-i18n="team.take_test"
                aria-label="–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç: ${escapeHtml(t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}"
                type="button">
                –ü—Ä–æ–π—Ç–∏
              </button>
            </li>
          `).join('')}
        </ul>
      </section>
    `;
    
    AkylI18n.applyI18n(AkylI18n.getLang(), out);
    
    document.querySelectorAll('.take').forEach(b => {
      b.onclick = () => startTest(b.dataset.id);
      b.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          b.click();
        }
      });
    });
  } catch (err) {
    console.error(err);
    out.setAttribute('aria-busy', 'false');
    out.innerHTML = `
      <div class="error-message" role="alert" aria-live="assertive">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤</p>
        <p class="error-hint">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
        <button class="primary" onclick="location.reload()" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
      </div>
    `;
  }
}

async function renderResultsSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</span></div><p data-i18n="team.loading_results">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  try {
    const res = await fetch('/api/me/results', { headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const rows = await res.json();
    out.setAttribute('aria-busy', 'false');
    
    if (!rows.length) {
      out.innerHTML = `
        <div class="empty-state" role="status" aria-live="polite">
          <div class="empty-icon">üìä</div>
          <p data-i18n="team.no_results" class="empty-message">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç</p>
          <p class="empty-hint">–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.</p>
        </div>
      `;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
    out.innerHTML = `
      <section aria-labelledby="results-heading">
        <h3 id="results-heading" class="sr-only" data-i18n="team.tab.results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
        <div class="table-wrapper" role="region" aria-label="–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤">
          <table class="results-table" role="table" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
            <thead>
              <tr>
                <th scope="col" data-i18n="team.test_title">–¢–µ—Å—Ç</th>
                <th scope="col" data-i18n="team.score">–ë–∞–ª–ª—ã</th>
                <th scope="col" data-i18n="team.date">–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map((r, idx) => `
                <tr role="row">
                  <td role="cell">${escapeHtml(r.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</td>
                  <td role="cell" class="score" aria-label="–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${r.score || 0}">
                    <strong>${r.score || 0}</strong>
                  </td>
                  <td role="cell" class="date">${escapeHtml(r.taken_at || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="results-summary" role="region" aria-label="–°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤">
          <p class="summary-text">
            –í—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: <strong>${rows.length}</strong>
          </p>
          <p class="summary-text">
            –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: <strong>${Math.round(rows.reduce((sum, r) => sum + (r.score || 0), 0) / rows.length)}</strong>
          </p>
        </div>
      </section>
    `;
    
    AkylI18n.applyI18n(AkylI18n.getLang(), out);
  } catch (err) {
    console.error(err);
    out.setAttribute('aria-busy', 'false');
    out.innerHTML = `
      <div class="error-message" role="alert" aria-live="assertive">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>
        <p class="error-hint">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
        <button class="primary" onclick="location.reload()" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
      </div>
    `;
  }
};

async function renderSettingsSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</span></div><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
  if (!teamData) {
    try {
      const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
      const j = await res.json();
      if (j.ok) {
        teamData = j.team;
        updateTeamNameHeader();
      }
    } catch (err) {
      console.error(err);
      out.setAttribute('aria-busy', 'false');
      out.innerHTML = `
        <div class="error-message" role="alert">
          <p class="error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>
      `;
      return;
    }
  }
  
  out.setAttribute('aria-busy', 'false');
  
  if (teamData) {
    out.innerHTML = `
      <section aria-labelledby="settings-heading">
        <h3 id="settings-heading" data-i18n="team.tab.settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
        <div class="settings-card" role="region" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥—ã">
          <dl class="settings-list">
            <div class="settings-item">
              <dt data-i18n="team.team_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:</dt>
              <dd>${escapeHtml(teamData.team_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}</dd>
            </div>
            <div class="settings-item">
              <dt data-i18n="team.login">–õ–æ–≥–∏–Ω:</dt>
              <dd>${escapeHtml(teamData.login || '–ù–µ —É–∫–∞–∑–∞–Ω')}</dd>
            </div>
            ${teamData.captain_email ? `
            <div class="settings-item">
              <dt data-i18n="team.email">Email –∫–∞–ø–∏—Ç–∞–Ω–∞:</dt>
              <dd><a href="mailto:${escapeHtml(teamData.captain_email)}" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å email">${escapeHtml(teamData.captain_email)}</a></dd>
            </div>
            ` : ''}
            ${teamData.captain_phone ? `
            <div class="settings-item">
              <dt data-i18n="team.phone">–¢–µ–ª–µ—Ñ–æ–Ω –∫–∞–ø–∏—Ç–∞–Ω–∞:</dt>
              <dd><a href="tel:${escapeHtml(teamData.captain_phone)}" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">${escapeHtml(teamData.captain_phone)}</a></dd>
            </div>
            ` : ''}
            ${teamData.school ? `
            <div class="settings-item">
              <dt data-i18n="team.school">–®–∫–æ–ª–∞:</dt>
              <dd>${escapeHtml(teamData.school)}</dd>
            </div>
            ` : ''}
            ${teamData.city ? `
            <div class="settings-item">
              <dt data-i18n="team.city">–ì–æ—Ä–æ–¥:</dt>
              <dd>${escapeHtml(teamData.city)}</dd>
            </div>
            ` : ''}
          </dl>
          <div class="settings-note" role="note" aria-label="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
            <p class="small-muted" data-i18n="team.settings_note">–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
          </div>
        </div>
      </section>
    `;
  } else {
    out.innerHTML = '<div class="empty-state" role="status"><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
  }
  
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

async function startTest(id) {
  const out = document.getElementById('tabContent');
  out.innerHTML = t('team.loading_questions');
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  try {
    const res = await fetch('/api/tests/' + id);
    if (res.status === 403) {
      out.innerHTML = `<p data-i18n="team.test_unavailable">–¢–µ—Å—Ç —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>`;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
    const qs = await res.json();
    if (!qs.length) {
      out.innerHTML = `<p data-i18n="team.empty_test">–ü—É—Å—Ç–æ–π —Ç–µ—Å—Ç</p>`;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
  let remainingSec = 0;
    const testMetaRes = await fetch('/api/tests', { headers: {} });
    const allTests = await testMetaRes.json();
    const testMeta = allTests.find(x => String(x.id) === String(id));
  const durMins = (testMeta && testMeta.duration_minutes) ? testMeta.duration_minutes : 60;
    remainingSec = durMins * 60;
    
    const timerDiv = document.createElement('div');
    timerDiv.className = 'test-timer';
    
    const interval = setInterval(() => {
      remainingSec--;
      timerDiv.textContent = `${t('team.timer')}: ` + fmt(remainingSec);
      if (remainingSec <= 0) {
        clearInterval(interval);
        finish();
      }
    }, 1000);
    
    let idx = 0;
    const answers = {};
    
    function show() {
      const q = qs[idx];
      out.innerHTML = '';
    out.appendChild(timerDiv);
    const block = document.createElement('div');
      block.innerHTML = `
        <div class="question-block" role="region" aria-labelledby="question-number">
          <div class="question-header">
            <h4 id="question-number" class="question-number">–í–æ–ø—Ä–æ—Å ${idx + 1} –∏–∑ ${qs.length}</h4>
            <div class="question-progress" role="progressbar" aria-valuenow="${idx + 1}" aria-valuemin="1" aria-valuemax="${qs.length}" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å: –≤–æ–ø—Ä–æ—Å ${idx + 1} –∏–∑ ${qs.length}">
              <div class="progress-bar" style="width: ${((idx + 1) / qs.length) * 100}%"></div>
            </div>
          </div>
          <p class="question-text" id="question-text-${idx}">${escapeHtml(q.text)}</p>
          <fieldset class="question-options" role="radiogroup" aria-labelledby="question-text-${idx}">
            ${q.options && q.options.length ? q.options.map((o, i) => `
              <div class="option-item">
                <label>
                  <input 
                    type="radio" 
                    name="opt" 
                    value="${i}" 
                    id="opt-${idx}-${i}"
                    aria-describedby="question-text-${idx}"
                    ${answers[q.id] === String(i) ? 'checked' : ''}
                  />
                  <span>${escapeHtml(o)}</span>
                </label>
              </div>
            `).join('') : `
              <div class="text-answer">
                <label for="txt-${idx}" class="sr-only">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç</label>
                <input 
                  id="txt-${idx}" 
                  type="text" 
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                  aria-labelledby="question-text-${idx}"
                  value="${answers[q.id] || ''}"
                />
              </div>
            `}
          </fieldset>
        </div>
        <nav class="test-navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º">
          <button 
            id="prev" 
            class="nav-btn" 
            ${idx === 0 ? 'disabled aria-disabled="true"' : ''}
            aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å"
            type="button">
            ${t('team.prev')}
          </button>
          <button 
            id="next" 
            class="primary"
            aria-label="${idx >= qs.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç' : '–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å'}"
            type="button">
            ${idx >= qs.length - 1 ? t('team.done') : t('team.next')}
          </button>
        </nav>
      `;
    out.appendChild(block);
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
      if (q.options && q.options.length) {
        const savedAnswer = answers[q.id];
        if (savedAnswer !== null && savedAnswer !== undefined) {
          const radio = document.getElementById(`opt-${idx}-${savedAnswer}`);
          if (radio) radio.checked = true;
        }
      } else {
        const textInput = document.getElementById(`txt-${idx}`);
        if (textInput) {
          textInput.value = answers[q.id] || '';
        }
      }
      
      if (idx > 0) {
        document.getElementById('prev').onclick = () => {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
          if (q.options && q.options.length) {
            const sel = document.querySelector('input[name="opt"]:checked');
            answers[q.id] = sel ? sel.value : null;
          } else {
            const textInput = document.getElementById(`txt-${idx}`);
            answers[q.id] = textInput ? textInput.value : '';
          }
          if (idx > 0) {
            idx--;
            show();
          }
        };
      }
      
      document.getElementById('next').onclick = () => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç
        if (q.options && q.options.length) {
          const sel = document.querySelector('input[name="opt"]:checked');
          answers[q.id] = sel ? sel.value : null;
        } else {
          const textInput = document.getElementById(`txt-${idx}`);
          answers[q.id] = textInput ? textInput.value : '';
        }
        idx++;
        if (idx >= qs.length) {
          finish();
        } else {
          show();
        }
      };
      
      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞
      if (q.options && q.options.length) {
        document.querySelectorAll('input[name="opt"]').forEach(radio => {
          radio.addEventListener('change', () => {
            answers[q.id] = radio.value;
          });
        });
      } else {
        const textInput = document.getElementById(`txt-${idx}`);
        if (textInput) {
          textInput.addEventListener('input', () => {
            answers[q.id] = textInput.value;
          });
        }
      }
    }
    
    async function finish() {
      out.innerHTML = t('team.submitting');
      clearInterval(interval);
      
      try {
        const resp = await fetch('/api/tests/' + id + '/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ answers })
        });
        const j = await resp.json();
        if (!j.ok) {
          out.innerHTML = `<p style="color: var(--danger);" data-i18n="team.error">–û—à–∏–±–∫–∞</p>`;
          AkylI18n.applyI18n(AkylI18n.getLang(), out);
          return;
        }
        const maxScore = qs.length * 10; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 10 –±–∞–ª–ª–æ–≤ –∑–∞ –≤–æ–ø—Ä–æ—Å
        const percentage = Math.round(((j.score || 0) / maxScore) * 100);
        out.innerHTML = `
          <div class="test-result" role="region" aria-live="polite" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞">
            <div class="result-icon" aria-hidden="true">${percentage >= 70 ? 'üéâ' : percentage >= 50 ? 'üëç' : 'üìù'}</div>
            <h3 data-i18n="team.done">–ì–æ—Ç–æ–≤–æ</h3>
            <div class="result-score">
              <p class="result-label">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</p>
              <p class="result-value"><strong>${j.score || 0}</strong> <span class="result-max">–∏–∑ ${maxScore}</span></p>
              <div class="result-percentage" aria-label="–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${percentage}%">
                <div class="percentage-bar">
                  <div class="percentage-fill" style="width: ${percentage}%"></div>
                </div>
                <span class="percentage-text">${percentage}%</span>
              </div>
            </div>
            <div class="result-actions">
              <button class="primary" onclick="document.getElementById('tabResults').click()" type="button">
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
              </button>
              <button class="nav-btn" onclick="document.getElementById('tabTests').click()" type="button">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–∞–º
              </button>
            </div>
          </div>
        `;
        AkylI18n.applyI18n(AkylI18n.getLang(), out);
      } catch (err) {
        console.error(err);
        out.innerHTML = `<p style="color: var(--danger);" data-i18n="team.error">–û—à–∏–±–∫–∞</p>`;
        AkylI18n.applyI18n(AkylI18n.getLang(), out);
      }
    }
    
    function fmt(s) {
      if (s < 0) s = 0;
      const m = Math.floor(s / 60);
      const ss = String(s % 60).padStart(2, '0');
      return `${m}:${ss}`;
    }
    
    show();
  } catch (err) {
    console.error(err);
    out.innerHTML = '<p style="color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞</p>';
  }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è (–∫—Ä–æ–º–µ email)
async function handleInlineEdit(field) {
  if (!teamData) return;
  const fieldNames = {
    team_name: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã',
    captain_name: '–ò–º—è –∫–∞–ø–∏—Ç–∞–Ω–∞',
    captain_phone: '–¢–µ–ª–µ—Ñ–æ–Ω –∫–∞–ø–∏—Ç–∞–Ω–∞',
    school: '–®–∫–æ–ª–∞',
    city: '–ì–æ—Ä–æ–¥'
  };
  const current = (teamData[field] || '').toString();
  const label = fieldNames[field] || field;
  const next = window.prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è "${label}":`, current);
  if (next === null) return;

  try {
    const body = {};
    body[field] = next.trim();
    const res = await fetch('/api/me', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify(body)
    });
    const j = await res.json();
    if (!res.ok || !j.ok) {
      const msg = j && j.error ? j.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      alert(msg);
      return;
    }
    teamData = j.team || teamData;
    updateTeamNameHeader();
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ team, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    try {
      const currentStored = JSON.parse(localStorage.getItem('team') || 'null');
      if (currentStored && Number(currentStored.id) === Number(teamData.id)) {
        localStorage.setItem('team', JSON.stringify({ ...currentStored, ...teamData }));
      }
    } catch {}
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å–µ–∫—Ü–∏—é
    renderHomeSection(document.getElementById('tabHome'));
  } catch (err) {
    console.error(err);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
}

// –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
async function handlePasswordChange() {
  const oldPassword = window.prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:');
  if (oldPassword === null || oldPassword === '') return;
  
  const newPassword = window.prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–≥–ª–∞–≤–Ω–∞—è, —Å—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞ –∏ —Ü–∏—Ñ—Ä–∞):');
  if (newPassword === null || newPassword === '') return;

  const confirmPassword = window.prompt('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:');
  if (confirmPassword === null || confirmPassword !== newPassword) {
    alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.');
    return;
  }

  try {
    const res = await fetch('/api/me/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ oldPassword, newPassword })
    });
    const j = await res.json();
    if (!res.ok || !j.ok) {
      const msg = j && j.error ? j.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å';
      alert(msg);
      return;
    }
    alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω.');
  } catch (err) {
    console.error(err);
    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
}

// –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('keydown', (e) => {
    const tabs = Array.from(document.querySelectorAll('.tab-btn'));
    const currentIndex = tabs.indexOf(btn);
    
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
      e.preventDefault();
      let nextIndex;
      if (e.key === 'ArrowRight') {
        nextIndex = (currentIndex + 1) % tabs.length;
      } else {
        nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
      }
      tabs[nextIndex].focus();
      tabs[nextIndex].click();
    } else if (e.key === 'Home') {
      e.preventDefault();
      tabs[0].focus();
      tabs[0].click();
    } else if (e.key === 'End') {
      e.preventDefault();
      tabs[tabs.length - 1].focus();
      tabs[tabs.length - 1].click();
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL (/team/<section>)
function attachTabHandlers() {
  const map = {
    tabHome: { section: 'main', render: renderHomeSection },
    tabTests: { section: 'tests', render: renderTestsSection },
    tabResults: { section: 'results', render: renderResultsSection },
    tabSettings: { section: 'settings', render: renderSettingsSection },
    tabPractice: { section: 'practice', render: renderPracticeSection },
    tabRules: { section: 'rules', render: renderRulesSection }
  };

  Object.keys(map).forEach(id => {
    const btn = document.getElementById(id);
    if (!btn) return;
    const { section, render } = map[id];
    btn.onclick = (e) => {
      const targetBtn = e.currentTarget;
      // –ú–µ–Ω—è–µ–º URL, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü—É
      const newPath = section === 'main' ? '/team/main' : `/team/${section}`;
      if (window.location.pathname !== newPath && window.history && window.history.pushState) {
        window.history.pushState({ section }, '', newPath);
      }
      render(targetBtn);
    };
  });
}

// Router –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞–Ω–∏—Ü: /team, /team/main, /team/tests, /team/results, /team/settings, /team/practice, /team/rules
function initTeamSectionFromUrl() {
  const path = window.location.pathname || '';
  const match = path.match(/^\/team\/([^/]+)/);
  const section = match ? match[1] : 'main';
  const map = {
    main: 'tabHome',
    tests: 'tabTests',
    results: 'tabResults',
    settings: 'tabSettings',
    practice: 'tabPractice',
    rules: 'tabRules'
  };
  const btnId = map[section] || 'tabHome';
  const btn = document.getElementById(btnId);
  if (btn) {
    btn.click();
  } else {
    document.getElementById('tabHome').click();
  }
}

attachTabHandlers();
initTeamSectionFromUrl();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞
window.addEventListener('akyl-langchange', () => {
  if (typeof AkylI18n !== 'undefined') {
    AkylI18n.applyI18n(AkylI18n.getLang());
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
    const activeTab = document.querySelector('.tab-btn.active');
    if (activeTab) {
      activeTab.click();
    }
  }
});
</script>
</body>
</html>
