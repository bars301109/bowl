
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="description" content="–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã - Akylman Quiz Bowl">
  <title data-i18n="team.title">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="../css/style.css"/>
  <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
</head>
<body class="admin-panel">
<div class="container">
  <div class="lang-switch text-end" role="group" aria-label="–í—ã–±–æ—Ä —è–∑—ã–∫–∞">
    <button data-lang="ru" aria-label="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫" aria-pressed="true">–†–£</button> 
    <button data-lang="ky" aria-label="–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π —è–∑—ã–∫" aria-pressed="false">–ö–´</button>
  </div>
  <a href="/" aria-label="–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"><img src="../images/logos.jpeg" class="logo-center img-fluid" alt="Akylman Quiz Bowl" width="120" height="48"/></a>
  <nav class="topbar d-flex justify-content-end gap-2 flex-wrap" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <a class="nav-btn" href="/" data-i18n="nav.home" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É">–ì–ª–∞–≤–Ω–∞—è</a>
    <button class="link-pill" id="logout" data-i18n="nav.logout" aria-label="–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞" type="button">–í—ã—Ö–æ–¥</button>
  </nav>
  <main class="team-page-main" role="main">
    <h1 data-i18n="team.title" class="sr-only">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</h1>
    <h2 data-i18n="team.title" class="visually-hidden">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</h2>
    <div class="team-layout">
      <nav class="team-tabs" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º">
        <h2 id="teamNameHeader" class="team-name-header">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <button id="tabHome" class="tab-btn active" role="tab" aria-selected="true" aria-controls="tabContent" data-section="main" data-i18n="team.tab.home" tabindex="0">–ì–ª–∞–≤–Ω–∞—è</button> 
        <button id="tabTests" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="tests" data-i18n="team.tab.tests" tabindex="-1">–¢–µ—Å—Ç—ã</button> 
        <button id="tabResults" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="results" data-i18n="team.tab.results" tabindex="-1">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button> 
        <button id="tabPractice" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="practice" data-i18n="team.tab.practice" tabindex="-1">–ü—Ä–∞–∫—Ç–∏–∫–∞</button> 
        <button id="tabRules" class="tab-btn" role="tab" aria-selected="false" aria-controls="tabContent" data-section="rules" data-i18n="team.tab.rules" tabindex="-1">–ü—Ä–∞–≤–∏–ª–∞</button>
      </nav>
      <div id="tabContent" class="team-main" role="tabpanel" aria-labelledby="tabHome" aria-live="polite"></div>
    </div>
  </main>
</div>

<!-- Password Change Modal -->
<div id="passwordChangeModal" class="reset-modal" style="display: none;">
  <div class="reset-modal-content">
    <div class="reset-modal-header">
      <h3>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
      <button class="reset-close-btn" onclick="closePasswordChangeModal(event)" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    
    <div id="passwordStep1" class="reset-step">
      <p class="reset-description">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</p>
      <div class="form-row">
        <label>
          <span>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</span>
          <input type="password" id="passwordOldPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" required autocomplete="current-password"/>
        </label>
      </div>
      <div id="passwordStep1Message" class="reset-message" style="display: none;"></div>
      <div class="reset-actions">
        <button class="primary" onclick="verifyOldPassword()" id="verifyOldPasswordBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="nav-btn" onclick="closePasswordChangeModal(event)">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    
    <div id="passwordStep2" class="reset-step" style="display: none;">
      <p class="reset-description">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</p>
      <div class="form-row">
        <label>
          <span>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</span>
          <input type="password" id="passwordNewPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required autocomplete="new-password"/>
        </label>
      </div>
      <div class="form-row">
        <label>
          <span>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</span>
          <input type="password" id="passwordConfirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required autocomplete="new-password"/>
        </label>
      </div>
      <div class="password-requirements" id="passwordChangeReqs" style="margin-top: 12px;">
        <div class="requirement" id="pwd-req-length"><span>8 —Å–∏–º–≤–æ–ª–æ–≤</span></div>
        <div class="requirement" id="pwd-req-upper"><span>–ó–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞</span></div>
        <div class="requirement" id="pwd-req-lower"><span>–°—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞</span></div>
        <div class="requirement" id="pwd-req-number"><span>–¶–∏—Ñ—Ä–∞</span></div>
      </div>
      <div id="passwordStep2Message" class="reset-message" style="display: none;"></div>
      <div class="reset-actions">
        <button class="primary" onclick="changePassword()" id="changePasswordBtn" data-i18n="team.change_password">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        <button class="nav-btn" onclick="goBackToPasswordStep1()">–ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Field Edit Modal -->
<div id="fieldEditModal" class="reset-modal" style="display: none;">
  <div class="reset-modal-content" style="max-width: 500px;">
    <div class="reset-modal-header">
      <h3 id="fieldEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
      <button class="reset-close-btn" onclick="closeFieldEditModal(event)" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    
    <div class="reset-step">
      <p class="reset-description" id="fieldEditDescription">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</p>
      <div class="form-row">
        <label>
          <span id="fieldEditLabel">–ó–Ω–∞—á–µ–Ω–∏–µ</span>
          <input type="text" id="fieldEditInput" placeholder="" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 15px;"/>
        </label>
      </div>
      <div id="fieldEditMessage" class="reset-message" style="display: none;"></div>
      <div class="reset-actions">
        <button class="primary" onclick="saveFieldEdit()" id="saveFieldBtn" data-i18n="team.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="nav-btn" onclick="closeFieldEditModal(event)" data-i18n="team.cancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>
</div>

<!-- Members Edit Modal -->
<div id="membersEditModal" class="reset-modal" style="display: none;">
  <div class="reset-modal-content" style="max-width: 600px;">
    <div class="reset-modal-header">
      <h3 data-i18n="team.edit_members">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
      <button class="reset-close-btn" onclick="closeMembersEditModal(event)" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    
    <div class="reset-step">
      <p class="reset-description" data-i18n="team.edit_members_description">–î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã:</p>
      <div id="membersEditList" style="margin-bottom: 16px;">
        <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <button type="button" class="nav-btn" onclick="addMemberRow()" style="margin-bottom: 16px;" data-i18n="team.add_member">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
      <div id="membersEditMessage" class="reset-message" style="display: none;"></div>
      <div class="reset-actions">
        <button class="primary" onclick="saveMembers()" id="saveMembersBtn" data-i18n="team.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="nav-btn" onclick="closeMembersEditModal(event)" data-i18n="team.cancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="../js/i18n.js"></script>
<script>AkylI18n.initSwitcher();</script>
<script>
const token = localStorage.getItem('akylman_token');
if (!token) location.href = '/login';

let teamData = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
function t(key) {
  if (typeof AkylI18n !== 'undefined' && AkylI18n.t) {
    return AkylI18n.t(key);
  }
  return key;
}

function updateTeamNameHeader() {
  const teamNameHeader = document.getElementById('teamNameHeader');
  if (teamNameHeader && teamData) {
    teamNameHeader.textContent = teamData.team_name || '–ö–æ–º–∞–Ω–¥–∞';
  }
}

async function load() {
  const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
  const j = await res.json();
  if (!j.ok) {
    localStorage.removeItem('akylman_token');
    location.href = '/login';
    return;
  }
  teamData = j.team;
  updateTeamNameHeader();
}

load();

document.getElementById('logout').onclick = () => {
  localStorage.removeItem('akylman_token');
  localStorage.removeItem('team');
  location.href = '/';
};

function setActiveTab(btn) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('active');
    b.setAttribute('aria-selected', 'false');
    b.setAttribute('tabindex', '-1');
  });
  btn.classList.add('active');
  btn.setAttribute('aria-selected', 'true');
  btn.setAttribute('tabindex', '0');
  document.getElementById('tabContent').setAttribute('aria-labelledby', btn.id);
}

async function renderHomeSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
  if (!teamData) {
    try {
      const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
      const j = await res.json();
      if (j.ok) {
        teamData = j.team;
        updateTeamNameHeader();
      }
    } catch (err) {
      console.error(err);
      out.setAttribute('aria-busy', 'false');
      out.innerHTML = '<div class="error-message" role="alert"><p style="color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p></div>';
      return;
    }
  }
  
  out.setAttribute('aria-busy', 'false');
  
  if (teamData) {
    const lang = AkylI18n.getLang();
    let categoryLabel = '';
    if (teamData.category_name_ru || teamData.category_name_ky) {
      categoryLabel = lang === 'ky'
        ? (teamData.category_name_ky || teamData.category_name_ru || '')
        : (teamData.category_name_ru || teamData.category_name_ky || '');
    } else if (teamData.category_id) {
      categoryLabel = 'ID: ' + teamData.category_id;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã
    let membersHtml = '';
    if (teamData.members && teamData.members.length > 0) {
      membersHtml = teamData.members.map((m, idx) => `<li><span class="member-name">${m.name || '–£—á–∞—Å—Ç–Ω–∏–∫'}</span>${m.class ? ` <span class="member-class">‚Äî ${m.class}</span>` : ''}</li>`).join('');
    } else {
      membersHtml = '<li class="empty-state">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</li>';
    }
    
    out.innerHTML = `
      <section aria-labelledby="welcome-heading">
        <h3 id="welcome-heading" data-i18n="team.welcome">–ö–∞–±–∏–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã</h3>
        <div class="team-info" role="region" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–µ">
          <dl class="info-list">
            <div class="info-item editable" data-field="team_name">
              <dt data-i18n="team.team_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.team_name || '')}</span>
                <button type="button" class="inline-edit-btn" data-field="team_name" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            <div class="info-item">
              <dt data-i18n="team.category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</dt>
              <dd>
                <span class="info-value">${categoryLabel ? escapeHtml(categoryLabel) : '–ù–µ –≤—ã–±—Ä–∞–Ω–∞'}</span>
              </dd>
            </div>
            <div class="info-item editable" data-field="captain_name">
              <dt data-i18n="team.captain">–ö–∞–ø–∏—Ç–∞–Ω:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.captain_name || '')}</span>
                <button type="button" class="inline-edit-btn" data-field="captain_name" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ${teamData.captain_phone ? `
            <div class="info-item editable" data-field="captain_phone">
              <dt data-i18n="team.phone">–¢–µ–ª–µ—Ñ–æ–Ω:</dt>
              <dd>
                <span class="info-value"><a href="tel:${escapeHtml(teamData.captain_phone)}" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∫–∞–ø–∏—Ç–∞–Ω—É">${escapeHtml(teamData.captain_phone)}</a></span>
                <button type="button" class="inline-edit-btn" data-field="captain_phone" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ` : `
            <div class="info-item editable" data-field="captain_phone">
              <dt data-i18n="team.phone">–¢–µ–ª–µ—Ñ–æ–Ω:</dt>
              <dd>
                <span class="info-value small-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                <button type="button" class="inline-edit-btn" data-field="captain_phone" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            `}
            ${teamData.school ? `
            <div class="info-item editable" data-field="school">
              <dt data-i18n="team.school">–®–∫–æ–ª–∞:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.school)}</span>
                <button type="button" class="inline-edit-btn" data-field="school" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ` : `
            <div class="info-item editable" data-field="school">
              <dt data-i18n="team.school">–®–∫–æ–ª–∞:</dt>
              <dd>
                <span class="info-value small-muted">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                <button type="button" class="inline-edit-btn" data-field="school" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            `}
            ${teamData.city ? `
            <div class="info-item editable" data-field="city">
              <dt data-i18n="team.city">–ì–æ—Ä–æ–¥:</dt>
              <dd>
                <span class="info-value">${escapeHtml(teamData.city)}</span>
                <button type="button" class="inline-edit-btn" data-field="city" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            ` : `
            <div class="info-item editable" data-field="city">
              <dt data-i18n="team.city">–ì–æ—Ä–æ–¥:</dt>
              <dd>
                <span class="info-value small-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                <button type="button" class="inline-edit-btn" data-field="city" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </dd>
            </div>
            `}
          </dl>

          <section aria-labelledby="members-heading">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <h4 id="members-heading" data-i18n="team.members" style="margin: 0;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã:</h4>
              <button type="button" class="inline-edit-btn" onclick="handleMembersEdit(event)" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
            <ul class="members-list" role="list">
              ${membersHtml}
            </ul>
          </section>

          <section class="account-section" aria-labelledby="account-heading">
            <h4 id="account-heading">–ê–∫–∫–∞—É–Ω—Ç</h4>
            <dl class="info-list">
              ${teamData.captain_email ? `
              <div class="info-item">
                <dt data-i18n="team.email">Email –∫–∞–ø–∏—Ç–∞–Ω–∞:</dt>
                <dd><a href="mailto:${escapeHtml(teamData.captain_email)}" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å email –∫–∞–ø–∏—Ç–∞–Ω—É">${escapeHtml(teamData.captain_email)}</a></dd>
              </div>
              ` : ''}
              <div class="info-item">
                <dt>–ü–∞—Ä–æ–ª—å:</dt>
                <dd>
                  <span class="info-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                  <button type="button" class="inline-edit-btn" data-field="password" data-i18n="team.edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </dd>
              </div>
            </dl>
          </section>
        </div>
      </section>
    `;

    // –ù–∞–≤–µ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å"
    out.querySelectorAll('.inline-edit-btn').forEach(btn => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏–º–µ—é—Ç onclick (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
      if (btn.hasAttribute('onclick')) {
        return;
      }
      const field = btn.getAttribute('data-field');
      if (field === 'password') {
        btn.addEventListener('click', handlePasswordChange);
      } else if (field) {
        btn.addEventListener('click', () => handleInlineEdit(field));
      }
    });
  } else {
    out.innerHTML = '<div class="empty-state" role="status"><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
  }
  
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderRulesSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.innerHTML = `
    <section aria-labelledby="rules-heading">
      <h3 id="rules-heading" data-i18n="team.tab.rules">–ü—Ä–∞–≤–∏–ª–∞</h3>
      <p data-i18n="team.rules.hidden_note">–ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –∑–¥–µ—Å—å.</p>
      <div class="iframe-wrapper">
        <iframe 
          src="../pages/rules.pdf" 
          title="–ü—Ä–∞–≤–∏–ª–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è"
          aria-label="–î–æ–∫—É–º–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è"
          style="width:100%;height:480px;border:1px solid #eef4fb;border-radius:10px">
        </iframe>
      </div>
    </section>
  `;
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

function renderPracticeSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.innerHTML = `
    <section aria-labelledby="practice-heading">
      <h3 id="practice-heading" data-i18n="team.tab.practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</h3>
      <div class="practice-content" role="region" aria-label="–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏">
        <div class="practice-section">
          <h4>–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω —Ç–∞–∞–Ω—É—É ‚Äî “Ø–ª–≥“Ø —Å—É—Ä–æ–æ–ª–æ—Ä</h4>
          <ol class="practice-list">
            <li>–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –±–æ—Ä–±–æ—Ä—É –∫–∞–π—Å—ã? ‚Äî <strong>–ë–∏—à–∫–µ–∫</strong></li>
            <li>–´—Å—ã–∫-–ö”©–ª –∫–∞–π—Å—ã –¥—É–±–∞–Ω–¥–∞ –∂–∞–π–≥–∞—à–∫–∞–Ω? ‚Äî <strong>–´—Å—ã–∫-–ö”©–ª –æ–±–ª—É—Å—É</strong></li>
            <li>–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–¥—ã–Ω –º–∞–º–ª–µ–∫–µ—Ç—Ç–∏–∫ —Ç–∏–ª–∏? ‚Äî <strong>–ö—ã—Ä–≥—ã–∑ —Ç–∏–ª–∏</strong></li>
          </ol>
        </div>
        <div class="practice-section">
          <h4>–ê–¥–∞–±–∏—è—Ç ‚Äî “Ø–ª–≥“Ø —Å—É—Ä–æ–æ–ª–æ—Ä</h4>
          <ol class="practice-list">
            <li>¬´–ú–∞–Ω–∞—Å¬ª —ç–ø–æ—Å—É–Ω—É–Ω –±–∞—à–∫—ã –∫–∞–∞—Ä–º–∞–Ω—ã –∫–∏–º? ‚Äî <strong>–ú–∞–Ω–∞—Å</strong></li>
            <li>–ê. –ü—É—à–∫–∏–Ω–¥–∏–Ω –∫–∞–π—Å—ã —á—ã–≥–∞—Ä–º–∞—Å—ã–Ω–¥–∞ –¢–∞—Ç—å—è–Ω–∞ –±–∞—Ä? ‚Äî <strong>–ï–≤–≥–µ–Ω–∏–π –û–Ω–µ–≥–∏–Ω</strong></li>
            <li>¬´–´—Å—ã–∫-–ö”©–ª–¥“Ø–Ω –∫—É–ª–∞–≥—ã¬ª —á—ã–≥–∞—Ä–º–∞ –∫–∞–π—Å—ã –∂–∞–Ω—Ä–¥–∞? ‚Äî <strong>–ü–æ–≤–µ—Å—Ç—å/—ç—Å—Å–µ (–∫–æ–Ω—Ç–µ–∫—Å—Ç—Ç–∏–∫ –∫–∞–±—ã–ª)</strong></li>
          </ol>
        </div>
        <p class="small-muted practice-note">–ë—É–ª “Ø–ª–≥“Ø–ª”©—Ä —Ñ–æ—Ä–º–∞—Ç –º–µ–Ω–µ–Ω —Ç–∞–∞–Ω—ã—à—Ç—ã—Ä—É—É “Ø—á“Ø–Ω –≥–∞–Ω–∞.</p>
      </div>
    </section>
  `;
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
}

async function renderTestsSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤...</span></div><p data-i18n="team.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  try {
    let url = '/api/tests';
    if (teamData && teamData.category_id) {
      url += `?category_id=${encodeURIComponent(teamData.category_id)}`;
    }
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const tests = await res.json();
    out.setAttribute('aria-busy', 'false');
    
    if (!tests.length) {
      out.innerHTML = `
        <div class="empty-state" role="status" aria-live="polite">
          <div class="empty-icon">üìù</div>
          <p data-i18n="team.no_tests" class="empty-message">–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤</p>
          <p class="empty-hint">–¢–µ—Å—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å, –∫–æ–≥–¥–∞ –æ–Ω–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã.</p>
        </div>
      `;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
    function renderWindow(t) {
      if (t.window_start && t.window_end) {
        return `<span class="test-window" aria-label="–ü–µ—Ä–∏–æ–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∞">(${t.window_start} ‚Üí ${t.window_end})</span>`;
      }
      return '';
    }
    
    out.innerHTML = `
      <section aria-labelledby="tests-heading">
        <h3 id="tests-heading" class="sr-only" data-i18n="team.tab.tests">–¢–µ—Å—Ç—ã</h3>
        <ul class="test-list" role="list" aria-label="–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤">
          ${tests.map((t, idx) => `
            <li role="listitem" class="test-card">
              <div class="test-card-header">
                <h4 class="test-title">${escapeHtml(t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h4>
                ${renderWindow(t)}
              </div>
              ${t.description ? `<p class="test-description">${escapeHtml(t.description)}</p>` : ''}
              <button 
                data-id="${t.id}" 
                class="take primary" 
                data-i18n="team.take_test"
                aria-label="–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç: ${escapeHtml(t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}"
                type="button">
                –ü—Ä–æ–π—Ç–∏
              </button>
            </li>
          `).join('')}
        </ul>
      </section>
    `;
    
    AkylI18n.applyI18n(AkylI18n.getLang(), out);
    
    document.querySelectorAll('.take').forEach(b => {
      b.onclick = () => startTest(b.dataset.id);
      b.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          b.click();
        }
      });
    });
  } catch (err) {
    console.error(err);
    out.setAttribute('aria-busy', 'false');
    out.innerHTML = `
      <div class="error-message" role="alert" aria-live="assertive">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤</p>
        <p class="error-hint">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
        <button class="primary" onclick="location.reload()" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
      </div>
    `;
  }
}

async function renderResultsSection(btn) {
  if (btn) setActiveTab(btn);
  const out = document.getElementById('tabContent');
  out.setAttribute('aria-busy', 'true');
  out.innerHTML = '<div class="loading-spinner" role="status" aria-live="polite"><span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</span></div><p data-i18n="team.loading_results">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>';
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  try {
    const res = await fetch('/api/me/results', { headers: { 'Authorization': 'Bearer ' + token } });
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const rows = await res.json();
    out.setAttribute('aria-busy', 'false');
    
    if (!rows.length) {
      out.innerHTML = `
        <div class="empty-state" role="status" aria-live="polite">
          <div class="empty-icon">üìä</div>
          <p data-i18n="team.no_results" class="empty-message">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç</p>
          <p class="empty-hint">–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.</p>
        </div>
      `;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
    out.innerHTML = `
      <section aria-labelledby="results-heading">
        <h3 id="results-heading" class="sr-only" data-i18n="team.tab.results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
        <div class="table-wrapper" role="region" aria-label="–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤">
          <table class="results-table" role="table" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
            <thead>
              <tr>
                <th scope="col" data-i18n="team.test_title">–¢–µ—Å—Ç</th>
                <th scope="col" data-i18n="team.score">–ë–∞–ª–ª—ã</th>
                <th scope="col" data-i18n="team.date">–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map((r, idx) => `
                <tr role="row">
                  <td role="cell">${escapeHtml(r.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</td>
                  <td role="cell" class="score" aria-label="–ù–∞–±—Ä–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${r.score || 0}">
                    <strong>${r.score || 0}</strong>
                  </td>
                  <td role="cell" class="date">${escapeHtml(r.taken_at || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="results-summary" role="region" aria-label="–°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤">
          <p class="summary-text">
            –í—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: <strong>${rows.length}</strong>
          </p>
          <p class="summary-text">
            –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: <strong>${Math.round(rows.reduce((sum, r) => sum + (r.score || 0), 0) / rows.length)}</strong>
          </p>
        </div>
      </section>
    `;
    
    AkylI18n.applyI18n(AkylI18n.getLang(), out);
  } catch (err) {
    console.error(err);
    out.setAttribute('aria-busy', 'false');
    out.innerHTML = `
      <div class="error-message" role="alert" aria-live="assertive">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>
        <p class="error-hint">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>
        <button class="primary" onclick="location.reload()" type="button">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
      </div>
    `;
  }
};

async function startTest(id) {
  const out = document.getElementById('tabContent');
  out.innerHTML = t('team.loading_questions');
  AkylI18n.applyI18n(AkylI18n.getLang(), out);
  
  try {
    const res = await fetch('/api/tests/' + id);
    if (res.status === 403) {
      out.innerHTML = `<p data-i18n="team.test_unavailable">–¢–µ—Å—Ç —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>`;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
    const qs = await res.json();
    if (!qs.length) {
      out.innerHTML = `<p data-i18n="team.empty_test">–ü—É—Å—Ç–æ–π —Ç–µ—Å—Ç</p>`;
      AkylI18n.applyI18n(AkylI18n.getLang(), out);
      return;
    }
    
  let remainingSec = 0;
    // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
    const testMetaRes = await fetch('/api/tests');
    const allTests = await testMetaRes.json();
    const testMeta = allTests.find(x => String(x.id) === String(id));
  const durMins = (testMeta && testMeta.duration_minutes) ? testMeta.duration_minutes : 60;
    remainingSec = durMins * 60;
    
    const timerDiv = document.createElement('div');
    timerDiv.className = 'test-timer';
    
    const interval = setInterval(() => {
      remainingSec--;
      timerDiv.textContent = `${t('team.timer')}: ` + fmt(remainingSec);
      if (remainingSec <= 0) {
        clearInterval(interval);
        finish();
      }
    }, 1000);
    
    let idx = 0;
    const answers = {};
    
    function show() {
      const q = qs[idx];
      out.innerHTML = '';
    out.appendChild(timerDiv);
    const block = document.createElement('div');
      block.innerHTML = `
        <div class="question-block" role="region" aria-labelledby="question-number">
          <div class="question-header">
            <h4 id="question-number" class="question-number">–í–æ–ø—Ä–æ—Å ${idx + 1} –∏–∑ ${qs.length}</h4>
            <div class="question-progress" role="progressbar" aria-valuenow="${idx + 1}" aria-valuemin="1" aria-valuemax="${qs.length}" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å: –≤–æ–ø—Ä–æ—Å ${idx + 1} –∏–∑ ${qs.length}">
              <div class="progress-bar" style="width: ${((idx + 1) / qs.length) * 100}%"></div>
            </div>
          </div>
          <p class="question-text" id="question-text-${idx}">${escapeHtml(q.text)}</p>
          <fieldset class="question-options" role="radiogroup" aria-labelledby="question-text-${idx}">
            ${q.options && q.options.length ? q.options.map((o, i) => `
              <div class="option-item">
                <label>
                  <input 
                    type="radio" 
                    name="opt" 
                    value="${i}" 
                    id="opt-${idx}-${i}"
                    aria-describedby="question-text-${idx}"
                    ${answers[q.id] === String(i) ? 'checked' : ''}
                  />
                  <span>${escapeHtml(o)}</span>
                </label>
              </div>
            `).join('') : `
              <div class="text-answer">
                <label for="txt-${idx}" class="sr-only">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç</label>
                <input 
                  id="txt-${idx}" 
                  type="text" 
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                  aria-labelledby="question-text-${idx}"
                  value="${answers[q.id] || ''}"
                />
              </div>
            `}
          </fieldset>
        </div>
        <nav class="test-navigation" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º">
          <button 
            id="prev" 
            class="nav-btn" 
            ${idx === 0 ? 'disabled aria-disabled="true"' : ''}
            aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å"
            type="button">
            ${t('team.prev')}
          </button>
          <button 
            id="next" 
            class="primary"
            aria-label="${idx >= qs.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç' : '–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å'}"
            type="button">
            ${idx >= qs.length - 1 ? t('team.done') : t('team.next')}
          </button>
        </nav>
      `;
    out.appendChild(block);
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
      if (q.options && q.options.length) {
        const savedAnswer = answers[q.id];
        if (savedAnswer !== null && savedAnswer !== undefined) {
          const radio = document.getElementById(`opt-${idx}-${savedAnswer}`);
          if (radio) radio.checked = true;
        }
      } else {
        const textInput = document.getElementById(`txt-${idx}`);
        if (textInput) {
          textInput.value = answers[q.id] || '';
        }
      }
      
      if (idx > 0) {
        document.getElementById('prev').onclick = () => {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
          if (q.options && q.options.length) {
            const sel = document.querySelector('input[name="opt"]:checked');
            answers[q.id] = sel ? sel.value : null;
          } else {
            const textInput = document.getElementById(`txt-${idx}`);
            answers[q.id] = textInput ? textInput.value : '';
          }
          if (idx > 0) {
            idx--;
            show();
          }
        };
      }
      
      document.getElementById('next').onclick = () => {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç
        if (q.options && q.options.length) {
          const sel = document.querySelector('input[name="opt"]:checked');
          answers[q.id] = sel ? sel.value : null;
        } else {
          const textInput = document.getElementById(`txt-${idx}`);
          answers[q.id] = textInput ? textInput.value : '';
        }
        idx++;
        if (idx >= qs.length) {
          finish();
        } else {
          show();
        }
      };
      
      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞
      if (q.options && q.options.length) {
        document.querySelectorAll('input[name="opt"]').forEach(radio => {
          radio.addEventListener('change', () => {
            answers[q.id] = radio.value;
          });
        });
      } else {
        const textInput = document.getElementById(`txt-${idx}`);
        if (textInput) {
          textInput.addEventListener('input', () => {
            answers[q.id] = textInput.value;
          });
        }
      }
    }
    
    async function finish() {
      out.innerHTML = t('team.submitting');
      clearInterval(interval);
      
      try {
        const resp = await fetch('/api/tests/' + id + '/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ answers })
        });
        const j = await resp.json();
        if (!j.ok) {
          out.innerHTML = `<p style="color: var(--danger);" data-i18n="team.error">–û—à–∏–±–∫–∞</p>`;
          AkylI18n.applyI18n(AkylI18n.getLang(), out);
          return;
        }
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ, –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–æ–º
        const totalQuestions = typeof j.total === 'number' ? j.total : qs.length;
        const maxScore = typeof j.maxScore === 'number' ? j.maxScore : totalQuestions;
        const rawScore = typeof j.score === 'number' ? j.score : 0;
        const correctCount = typeof j.correct === 'number' ? j.correct : rawScore;
        const percentage = maxScore > 0 ? Math.round((rawScore / maxScore) * 100) : 0;
        out.innerHTML = `
          <div class="test-result" role="region" aria-live="polite" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞">
            <div class="result-icon" aria-hidden="true">${percentage >= 70 ? 'üéâ' : percentage >= 50 ? 'üëç' : 'üìù'}</div>
            <h3 data-i18n="team.done">–ì–æ—Ç–æ–≤–æ</h3>
            <div class="result-score">
              <p class="result-label">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</p>
              <p class="result-value"><strong>${correctCount}</strong> <span class="result-max">–∏–∑ ${totalQuestions}</span></p>
              <div class="result-percentage" aria-label="–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${percentage}%">
                <div class="percentage-bar">
                  <div class="percentage-fill" style="width: ${percentage}%"></div>
                </div>
                <span class="percentage-text">${percentage}%</span>
              </div>
            </div>
            <div class="result-actions">
              <button class="primary" onclick="document.getElementById('tabResults').click()" type="button">
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
              </button>
              <button class="nav-btn" onclick="document.getElementById('tabTests').click()" type="button">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–∞–º
              </button>
            </div>
          </div>
        `;
        AkylI18n.applyI18n(AkylI18n.getLang(), out);
      } catch (err) {
        console.error(err);
        out.innerHTML = `<p style="color: var(--danger);" data-i18n="team.error">–û—à–∏–±–∫–∞</p>`;
        AkylI18n.applyI18n(AkylI18n.getLang(), out);
      }
    }
    
    function fmt(s) {
      if (s < 0) s = 0;
      const m = Math.floor(s / 60);
      const ss = String(s % 60).padStart(2, '0');
      return `${m}:${ss}`;
    }
    
    show();
  } catch (err) {
    console.error(err);
    out.innerHTML = '<p style="color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞</p>';
  }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è (–∫—Ä–æ–º–µ email)
let currentEditField = null;

function handleInlineEdit(field) {
  if (!teamData) return;
  
  currentEditField = field;
  
  const fieldNames = {
    team_name: { label: t('team.team_name') || '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã', title: t('team.edit_field') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' },
    captain_name: { label: t('team.captain') || '–ö–∞–ø–∏—Ç–∞–Ω', title: t('team.edit_field') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' },
    captain_phone: { label: t('team.phone') || '–¢–µ–ª–µ—Ñ–æ–Ω', title: t('team.edit_field') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' },
    school: { label: t('team.school') || '–®–∫–æ–ª–∞', title: t('team.edit_field') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' },
    city: { label: t('team.city') || '–ì–æ—Ä–æ–¥', title: t('team.edit_field') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' }
  };
  
  const fieldInfo = fieldNames[field] || { label: field, title: t('team.edit_field') || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' };
  const current = (teamData[field] || '').toString();
  
  const modal = document.getElementById('fieldEditModal');
  if (!modal) return;
  
  document.getElementById('fieldEditTitle').textContent = fieldInfo.title;
  document.getElementById('fieldEditLabel').textContent = fieldInfo.label;
  document.getElementById('fieldEditInput').value = current;
  document.getElementById('fieldEditInput').placeholder = t('team.enter_value') || '–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ';
  document.getElementById('fieldEditMessage').style.display = 'none';
  document.getElementById('fieldEditMessage').textContent = '';
  
  modal.style.display = 'flex';
  document.getElementById('fieldEditInput').focus();
  document.getElementById('fieldEditInput').select();
  
  AkylI18n.applyI18n(AkylI18n.getLang(), modal);
}

function closeFieldEditModal(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const modal = document.getElementById('fieldEditModal');
  if (modal) {
    modal.style.display = 'none';
    currentEditField = null;
  }
}

async function saveFieldEdit() {
  if (!currentEditField || !teamData) return;
  
  const input = document.getElementById('fieldEditInput');
  const newValue = (input?.value || '').trim();
  const messageEl = document.getElementById('fieldEditMessage');
  const btn = document.getElementById('saveFieldBtn');
  
  btn.disabled = true;
  btn.textContent = t('team.saving') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
  
  try {
    const body = {};
    body[currentEditField] = newValue;
    
    const res = await fetch('/api/me', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify(body)
    });
    
    const j = await res.json();
    
    if (!res.ok || !j.ok) {
      const msg = j && j.error ? j.error : (t('team.save_error') || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
      messageEl.textContent = msg;
      messageEl.className = 'reset-message error';
      messageEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = t('team.save') || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      return;
    }
    
    teamData = j.team || teamData;
    updateTeamNameHeader();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ team, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    try {
      const currentStored = JSON.parse(localStorage.getItem('team') || 'null');
      if (currentStored && Number(currentStored.id) === Number(teamData.id)) {
        localStorage.setItem('team', JSON.stringify({ ...currentStored, ...teamData }));
      }
    } catch {}
    
    // –£—Å–ø–µ—à–Ω–æ
    messageEl.textContent = t('team.save_success') || '–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
    messageEl.className = 'reset-message success';
    messageEl.style.display = 'block';
    
    setTimeout(() => {
      closeFieldEditModal();
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å–µ–∫—Ü–∏—é
      renderHomeSection(document.getElementById('tabHome'));
    }, 1000);
    
  } catch (err) {
    console.error(err);
    messageEl.textContent = t('team.save_error') || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = t('team.save') || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  }
}

// –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è - –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function handlePasswordChange() {
  const modal = document.getElementById('passwordChangeModal');
  if (modal) {
    modal.style.display = 'flex';
    document.getElementById('passwordStep1').style.display = 'block';
    document.getElementById('passwordStep2').style.display = 'none';
    document.getElementById('passwordOldPassword').value = '';
    document.getElementById('passwordNewPassword').value = '';
    document.getElementById('passwordConfirmPassword').value = '';
    document.getElementById('passwordStep1Message').style.display = 'none';
    document.getElementById('passwordStep2Message').style.display = 'none';
    document.getElementById('passwordOldPassword').focus();
  }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
function closePasswordChangeModal(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const modal = document.getElementById('passwordChangeModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É 1 (–≤–≤–æ–¥ —Å—Ç–∞—Ä–æ–≥–æ –ø–∞—Ä–æ–ª—è)
function goBackToPasswordStep1() {
  document.getElementById('passwordStep1').style.display = 'block';
  document.getElementById('passwordStep2').style.display = 'none';
  document.getElementById('passwordOldPassword').value = '';
  document.getElementById('passwordStep1Message').style.display = 'none';
  document.getElementById('passwordOldPassword').focus();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø–∞—Ä–æ–ª—è
async function verifyOldPassword() {
  const oldPassword = document.getElementById('passwordOldPassword').value;
  const messageEl = document.getElementById('passwordStep1Message');
  
  if (!oldPassword) {
    messageEl.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('verifyOldPasswordBtn');
  btn.disabled = true;
  btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';

  try {
    const res = await fetch('/api/me/verify-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ password: oldPassword })
    });
    const j = await res.json();
    
    if (!res.ok || !j.ok) {
      messageEl.textContent = j && j.error ? j.error : '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
      messageEl.className = 'reset-message error';
      messageEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
      return;
    }

    // –ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 2
    document.getElementById('passwordStep1').style.display = 'none';
    document.getElementById('passwordStep2').style.display = 'block';
    document.getElementById('passwordNewPassword').focus();
    
    // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é
    const newPwdInput = document.getElementById('passwordNewPassword');
    const confirmPwdInput = document.getElementById('passwordConfirmPassword');
    
    newPwdInput.addEventListener('input', checkPasswordRequirements);
    confirmPwdInput.addEventListener('input', checkPasswordMatch);
    
  } catch (err) {
    console.error(err);
    messageEl.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é
function checkPasswordRequirements() {
  const password = document.getElementById('passwordNewPassword').value;
  const reqs = {
    length: password.length >= 8,
    upper: /[A-Z–ê-–Ø–Å]/.test(password),
    lower: /[a-z–∞-—è—ë]/.test(password),
    number: /[0-9]/.test(password)
  };
  
  document.getElementById('pwd-req-length').classList.toggle('met', reqs.length);
  document.getElementById('pwd-req-upper').classList.toggle('met', reqs.upper);
  document.getElementById('pwd-req-lower').classList.toggle('met', reqs.lower);
  document.getElementById('pwd-req-number').classList.toggle('met', reqs.number);
  
  checkPasswordMatch();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
function checkPasswordMatch() {
  const newPwd = document.getElementById('passwordNewPassword').value;
  const confirmPwd = document.getElementById('passwordConfirmPassword').value;
  const messageEl = document.getElementById('passwordStep2Message');
  
  if (confirmPwd && newPwd !== confirmPwd) {
    messageEl.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
  } else {
    messageEl.style.display = 'none';
  }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
async function changePassword() {
  const oldPassword = document.getElementById('passwordOldPassword').value;
  const newPassword = document.getElementById('passwordNewPassword').value;
  const confirmPassword = document.getElementById('passwordConfirmPassword').value;
  const messageEl = document.getElementById('passwordStep2Message');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
  const reqs = {
    length: newPassword.length >= 8,
    upper: /[A-Z–ê-–Ø–Å]/.test(newPassword),
    lower: /[a-z–∞-—è—ë]/.test(newPassword),
    number: /[0-9]/.test(newPassword)
  };
  
  if (!reqs.length || !reqs.upper || !reqs.lower || !reqs.number) {
    messageEl.textContent = '–ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    return;
  }
  
  if (newPassword !== confirmPassword) {
    messageEl.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('changePasswordBtn');
  btn.disabled = true;
  btn.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏–µ...';

  try {
    const res = await fetch('/api/me/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ oldPassword, newPassword })
    });
    const j = await res.json();
    
    if (!res.ok || !j.ok) {
      const msg = j && j.error ? j.error : '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å';
      messageEl.textContent = msg;
      messageEl.className = 'reset-message error';
      messageEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = t('team.change_password');
      return;
    }
    
    // –£—Å–ø–µ—à–Ω–æ
    messageEl.textContent = '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω';
    messageEl.className = 'reset-message success';
    messageEl.style.display = 'block';
    
    setTimeout(() => {
      closePasswordChangeModal();
    }, 1500);
    
  } catch (err) {
    console.error(err);
    messageEl.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å';
  }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã
function handleMembersEdit(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const modal = document.getElementById('membersEditModal');
  if (!modal || !teamData) {
    console.error('Modal or teamData not found');
    return;
  }
  
  modal.style.display = 'flex';
  const listContainer = document.getElementById('membersEditList');
  if (!listContainer) {
    console.error('membersEditList not found');
    return;
  }

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  const messageEl = document.getElementById('membersEditMessage');
  const btn = document.getElementById('saveMembersBtn');
  if (messageEl) {
    messageEl.style.display = 'none';
    messageEl.textContent = '';
  }
  if (btn) {
    btn.disabled = false;
    btn.textContent = t('team.save') || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  }
  
  listContainer.innerHTML = '';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  const members = teamData.members || [];
  if (Array.isArray(members)) {
    members.forEach((member, index) => {
      addMemberRow(member.name || '', member.class || '', index);
    });
  }
  
  // –ï—Å–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
  if (members.length === 0) {
    addMemberRow('', '', 0);
  }
  
  if (typeof AkylI18n !== 'undefined' && AkylI18n.applyI18n) {
    AkylI18n.applyI18n(AkylI18n.getLang(), modal);
  }
}

function addMemberRow(name = '', className = '', index = null) {
  const listContainer = document.getElementById('membersEditList');
  if (!listContainer) return;
  
  const rowIndex = index !== null ? index : listContainer.children.length;
  const row = document.createElement('div');
  row.className = 'member-edit-row';
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start;';
  row.innerHTML = `
    <div style="flex: 1;">
      <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 600;" data-i18n="team.member_name">–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
      <input type="text" class="member-name-input" placeholder="${t('team.member_name') || '–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞'}" value="${escapeHtml(name)}" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;"/>
    </div>
    <div style="flex: 1;">
      <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 600;" data-i18n="team.member_class">–ö–ª–∞—Å—Å</label>
      <input type="text" class="member-class-input" placeholder="${t('team.member_class') || '–ö–ª–∞—Å—Å'}" value="${escapeHtml(className)}" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;"/>
    </div>
    <button type="button" onclick="removeMemberRow(this)" style="margin-top: 24px; padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-width: 40px;" aria-label="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
  `;
  listContainer.appendChild(row);
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –∫ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
  if (typeof AkylI18n !== 'undefined' && AkylI18n.applyI18n) {
    AkylI18n.applyI18n(AkylI18n.getLang(), row);
  }
}

function removeMemberRow(btn) {
  const row = btn.closest('.member-edit-row');
  if (row) {
    row.remove();
  }
}

function closeMembersEditModal(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  const modal = document.getElementById('membersEditModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

async function saveMembers() {
  const listContainer = document.getElementById('membersEditList');
  if (!listContainer) return;
  
  const rows = listContainer.querySelectorAll('.member-edit-row');
  const members = [];
  
  rows.forEach(row => {
    const nameInput = row.querySelector('.member-name-input');
    const classInput = row.querySelector('.member-class-input');
    const name = (nameInput?.value || '').trim();
    const className = (classInput?.value || '').trim();
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
    if (name) {
      members.push({
        name: name,
        class: className || null
      });
    }
  });
  
  const messageEl = document.getElementById('membersEditMessage');
  const btn = document.getElementById('saveMembersBtn');
  
  btn.disabled = true;
  btn.textContent = t('team.saving') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
  
  try {
    const res = await fetch('/api/me', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ members: members })
    });
    
    const j = await res.json();
    
    if (!res.ok || !j.ok) {
      const msg = j && j.error ? j.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      messageEl.textContent = msg;
      messageEl.className = 'reset-message error';
      messageEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = t('team.save') || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      return;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    teamData = j.team || teamData;
    if (teamData.members && typeof teamData.members === 'string') {
      try {
        teamData.members = JSON.parse(teamData.members);
      } catch {
        teamData.members = [];
      }
    }
    
    // –£—Å–ø–µ—à–Ω–æ
    messageEl.textContent = '–£—á–∞—Å—Ç–Ω–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã';
    messageEl.className = 'reset-message success';
    messageEl.style.display = 'block';
    
    setTimeout(() => {
      closeMembersEditModal();
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å–µ–∫—Ü–∏—é
      renderHomeSection(document.getElementById('tabHome'));
    }, 1000);
    
  } catch (err) {
    console.error(err);
    messageEl.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
    messageEl.className = 'reset-message error';
    messageEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = t('team.save') || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  }
}

// –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('keydown', (e) => {
    const tabs = Array.from(document.querySelectorAll('.tab-btn'));
    const currentIndex = tabs.indexOf(btn);
    
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
      e.preventDefault();
      let nextIndex;
      if (e.key === 'ArrowRight') {
        nextIndex = (currentIndex + 1) % tabs.length;
      } else {
        nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
      }
      tabs[nextIndex].focus();
      tabs[nextIndex].click();
    } else if (e.key === 'Home') {
      e.preventDefault();
      tabs[0].focus();
      tabs[0].click();
    } else if (e.key === 'End') {
      e.preventDefault();
      tabs[tabs.length - 1].focus();
      tabs[tabs.length - 1].click();
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL (/team/<section>)
function attachTabHandlers() {
  const map = {
    tabHome: { section: 'main', render: renderHomeSection },
    tabTests: { section: 'tests', render: renderTestsSection },
    tabResults: { section: 'results', render: renderResultsSection },
    tabPractice: { section: 'practice', render: renderPracticeSection },
    tabRules: { section: 'rules', render: renderRulesSection }
  };

  Object.keys(map).forEach(id => {
    const btn = document.getElementById(id);
    if (!btn) return;
    const { section, render } = map[id];
    btn.onclick = (e) => {
      const targetBtn = e.currentTarget;
      // –ú–µ–Ω—è–µ–º URL, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü—É
      const newPath = section === 'main' ? '/team/main' : `/team/${section}`;
      if (window.location.pathname !== newPath && window.history && window.history.pushState) {
        window.history.pushState({ section }, '', newPath);
      }
      render(targetBtn);
    };
  });
}

// Router –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞–Ω–∏—Ü: /team, /team/main, /team/tests, /team/results, /team/practice, /team/rules
function initTeamSectionFromUrl() {
  const path = window.location.pathname || '';
  const match = path.match(/^\/team\/([^/]+)/);
  const section = match ? match[1] : 'main';
  const map = {
    main: 'tabHome',
    tests: 'tabTests',
    results: 'tabResults',
    practice: 'tabPractice',
    rules: 'tabRules'
  };
  const btnId = map[section] || 'tabHome';
  const btn = document.getElementById(btnId);
  if (btn) {
    btn.click();
  } else {
    document.getElementById('tabHome').click();
  }
}

attachTabHandlers();
initTeamSectionFromUrl();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
document.addEventListener('click', (e) => {
  const fieldModal = document.getElementById('fieldEditModal');
  const membersModal = document.getElementById('membersEditModal');
  const passwordModal = document.getElementById('passwordChangeModal');
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–∞ —Å–∞–º–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ (—Ñ–æ–Ω), –∞ –Ω–µ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º
  if (fieldModal && fieldModal.style.display === 'flex' && e.target === fieldModal) {
    closeFieldEditModal();
  }
  if (membersModal && membersModal.style.display === 'flex' && e.target === membersModal) {
    closeMembersEditModal();
  }
  if (passwordModal && passwordModal.style.display === 'flex' && e.target === passwordModal) {
    closePasswordChangeModal();
  }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
// –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.reset-modal-content').forEach(content => {
      content.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });
  });
} else {
  document.querySelectorAll('.reset-modal-content').forEach(content => {
    content.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—è
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && currentEditField) {
    const modal = document.getElementById('fieldEditModal');
    if (modal && modal.style.display === 'flex') {
      e.preventDefault();
      saveFieldEdit();
    }
  }
  if (e.key === 'Escape') {
    const fieldModal = document.getElementById('fieldEditModal');
    const membersModal = document.getElementById('membersEditModal');
    const passwordModal = document.getElementById('passwordChangeModal');
    
    if (fieldModal && fieldModal.style.display === 'flex') {
      closeFieldEditModal();
    } else if (membersModal && membersModal.style.display === 'flex') {
      closeMembersEditModal();
    } else if (passwordModal && passwordModal.style.display === 'flex') {
      closePasswordChangeModal();
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞
window.addEventListener('akyl-langchange', () => {
  if (typeof AkylI18n !== 'undefined') {
    AkylI18n.applyI18n(AkylI18n.getLang());
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
    const activeTab = document.querySelector('.tab-btn.active');
    if (activeTab) {
      activeTab.click();
    }
  }
});
</script>
</body>
</html>
