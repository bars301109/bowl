
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title data-i18n="register.title">Регистрация</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../css/style.css"/>
  <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
  <style>
    .password-requirements {
      margin-top: 6px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      font-size: 10px;
      font-weight: 400;
    }
    #passwordReqs .requirement {
      color: #ef4444 !important;
      transition: color 0.2s ease;
      font-weight: 400 !important;
      margin: 0;
      padding: 0;
    }
    #passwordReqs .requirement.met {
      color: #16a34a !important;
    }
    #passwordReqs .requirement.met,
    #passwordReqs .requirement.met span {
      color: #16a34a !important;
    }
    #passwordReqs .requirement:not(.met),
    #passwordReqs .requirement:not(.met) span {
      color: #ef4444 !important;
    }
    #passwordReqs .requirement span {
      font-weight: 400 !important;
      color: inherit;
      display: inline;
    }
    .requirement-icon {
      display: none !important;
    }
  </style>
</head>
<body class="admin-panel">
<div class="container">
  <div class="lang-switch text-end"><button data-lang="ru">РУ</button> <button data-lang="ky">КЫ</button></div>
  <a href="../index.html"><img src="../images/logo.png" class="logo-center img-fluid"/></a>
  <div class="topbar d-flex justify-content-end gap-2 flex-wrap">
    <a class="nav-btn" href="../index.html" data-i18n="nav.home">Главная</a>
    <a class="link-pill" href="./login.html" data-i18n="nav.login">Войти</a>
  </div>
  <div class="form-card">
    <div>
      <h2 data-i18n="register.title" class="grad-text">Регистрация команды</h2>
      <form id="regForm">
        <div class="form-row">
          <label><span data-i18n="register.team_name">Название команды</span><input name="team_name" required/></label>
          <label><span data-i18n="register.login">Логин команды</span><input name="login" required/></label>
        </div>
        <div class="form-row">
          <label>
            <span data-i18n="register.password">Пароль</span>
            <input type="password" name="password" id="passwordInput" required/>
            <div class="password-requirements" id="passwordReqs">
              <div class="requirement" id="req-length"><span data-i18n="register.password.length">8 символов</span></div>
              <div class="requirement" id="req-number"><span data-i18n="register.password.number">Цифра</span></div>
              <div class="requirement" id="req-lowercase"><span data-i18n="register.password.lowercase">Строчная буква</span></div>
              <div class="requirement" id="req-uppercase"><span data-i18n="register.password.uppercase">Заглавная буква</span></div>
            </div>
          </label>
          <label><span data-i18n="register.password2">Повтор пароля</span><input type="password" name="password2" required/></label>
        </div>
        <div class="form-row">
          <label><span data-i18n="register.captain_name">ФИО капитана</span><input name="captain_name" required/></label>
          <label><span data-i18n="register.captain_email">Email капитана</span><input type="email" name="captain_email"/></label>
        </div>
        <div class="form-row">
          <label><span data-i18n="register.captain_phone">Телефон капитана</span><input name="captain_phone"/></label>
          <label><span data-i18n="register.school">Школа</span><input name="school"/></label>
        </div>
        <div class="form-row">
          <label><span data-i18n="register.city">Город</span><input name="city"/></label>
          <label><span data-i18n="register.members_count">Количество участников</span><select id="members_count" name="members_count"><option>3</option><option>4</option><option>5</option><option>6</option></select></label>
        </div>
        <div id="members_fields"></div>
        <div class="mt-2">
          <button class="primary" type="submit" data-i18n="register.submit">Зарегистрироваться</button>
          <a class="nav-btn" href="../index.html" data-i18n="nav.home">Главная</a>
        </div>
      </form>
      <div id="msg" class="small-muted"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="../js/i18n.js"></script>
<script>AkylI18n.initSwitcher();</script>
<script>
const membersDiv = document.getElementById('members_fields');
const passwordInput = document.getElementById('passwordInput');

const requirements = {
  length: /^.{8,}$/,
  number: /\d/,
  lowercase: /[a-z]/,
  uppercase: /[A-Z]/
};

function updatePasswordRequirements(pw) {
  const checks = {
    length: requirements.length.test(pw),
    number: requirements.number.test(pw),
    lowercase: requirements.lowercase.test(pw),
    uppercase: requirements.uppercase.test(pw)
  };

  for (const [key, met] of Object.entries(checks)) {
    const elem = document.getElementById(`req-${key}`);
    if (elem) {
      if (met) {
        elem.classList.add('met');
      } else {
        elem.classList.remove('met');
      }
    }
  }

  return checks;
}

function isValidPassword(pw) {
  const checks = updatePasswordRequirements(pw);
  return Object.values(checks).every(v => v === true);
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email || '');
}

function renderMembers(n) {
  membersDiv.innerHTML = '';
  const lang = AkylI18n.getLang();
  for (let i = 2; i <= n; i++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'form-row';
    let memberLabel, classLabel;
    if (lang === 'ky') {
      memberLabel = `${i}-${AkylI18n.t('register.member_name')}`;
      classLabel = AkylI18n.t('register.member_class');
    } else {
      const ordinals = ['', '', 'второго', 'третьего', 'четвертого', 'пятого', 'шестого'];
      memberLabel = `ФИО ${ordinals[i] || i + '-го'} участника`;
      classLabel = AkylI18n.t('register.member_class');
    }
    wrapper.innerHTML = `<label><span>${memberLabel}</span><input name="member_${i}_name" required/></label><label><span>${classLabel}</span><input name="member_${i}_info"/></label>`;
    membersDiv.appendChild(wrapper);
  }
}

renderMembers(3);

document.getElementById('members_count').addEventListener('change', e => renderMembers(parseInt(e.target.value)));

window.addEventListener('akyl-langchange', () => {
  renderMembers(parseInt(document.getElementById('members_count').value));
  // Update password requirements text
  AkylI18n.applyI18n(AkylI18n.getLang());
});

// Update password requirements on input
if (passwordInput) {
  passwordInput.addEventListener('input', e => {
    updatePasswordRequirements(e.target.value);
  });

  // Initialize password requirements on focus
  passwordInput.addEventListener('focus', e => {
    updatePasswordRequirements(e.target.value);
  });

  // Also check on paste
  passwordInput.addEventListener('paste', e => {
    setTimeout(() => {
      updatePasswordRequirements(e.target.value);
    }, 10);
  });

  // Also check on keyup for better responsiveness
  passwordInput.addEventListener('keyup', e => {
    updatePasswordRequirements(e.target.value);
  });
}

document.getElementById('regForm').addEventListener('submit', async e => {
  e.preventDefault();
  const msg = document.getElementById('msg');
  msg.textContent = 'Отправка...';

  const data = Object.fromEntries(new FormData(e.target).entries());

  if (!isValidEmail(data.captain_email || '')) {
    msg.textContent = 'Некорректный email';
    msg.style.color = '#b00020';
    return;
  }

  if (data.password !== data.password2) {
    msg.textContent = 'Пароли не совпадают';
    msg.style.color = '#b00020';
    return;
  }

  if (!isValidPassword(data.password)) {
    msg.textContent = 'Пароль не соответствует требованиям';
    msg.style.color = '#b00020';
    return;
  }

  const members = [];
  const cnt = parseInt(data.members_count || 3);
  for (let i = 2; i <= cnt; i++) {
    const name = document.querySelector(`[name="member_${i}_name"]`)?.value || '';
    if (name) members.push({ name });
  }

  const payload = {
    team_name: data.team_name,
    login: data.login,
    password: data.password,
    captain_name: data.captain_name,
    captain_email: data.captain_email,
    captain_phone: data.captain_phone,
    members,
    school: data.school,
    city: data.city
  };

  try {
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if (!res.ok) {
      msg.textContent = j.error || 'Ошибка';
      msg.style.color = '#b00020';
      return;
    }
    msg.textContent = 'Успешно зарегистрированы';
    msg.style.color = '#166534';
    setTimeout(() => location.href = '/pages/login.html', 800);
  } catch (err) {
    console.error(err);
    msg.textContent = 'Сервер недоступен';
    msg.style.color = '#b00020';
  }
});
</script>
</body>
</html>
